(window.webpackJsonp=window.webpackJsonp||[]).push([[57],{369:function(_,v,t){"use strict";t.r(v);var s=t(8),l=Object(s.a)({},(function(){var _=this,v=_._self._c;return v("ContentSlotsDistributor",{attrs:{"slot-key":_.$parent.slotKey}},[v("h1",{attrs:{id:"事务消息投递与补偿"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#事务消息投递与补偿"}},[_._v("#")]),_._v(" 事务消息投递与补偿")]),_._v(" "),v("p",[v("img",{attrs:{src:"https://apple-web.oss-cn-hangzhou.aliyuncs.com/img/202406301518031.png",alt:"image-20240630142124537"}})]),_._v(" "),v("h2",{attrs:{id:"_1-事务消息投递过程"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_1-事务消息投递过程"}},[_._v("#")]),_._v(" 1. 事务消息投递过程")]),_._v(" "),v("ul",[v("li",[v("strong",[_._v("Step 1")]),_._v(": 开启本地事务")]),_._v(" "),v("li",[v("strong",[_._v("Step 2")]),_._v(": 执行本地业务")]),_._v(" "),v("li",[v("strong",[_._v("Step 3")]),_._v(": 消息表 "),v("code",[_._v("t_msg")]),_._v(" 写入记录，"),v("code",[_._v("status")]),_._v(" 为 0（待投递到 MQ）")]),_._v(" "),v("li",[v("strong",[_._v("Step 4")]),_._v(": 提交本地事务")]),_._v(" "),v("li",[v("strong",[_._v("Step 5")]),_._v(" "),v("ul",[v("li",[v("strong",[_._v("成功")]),_._v(":\n"),v("ul",[v("li",[_._v("投递消息到 MQ")]),_._v(" "),v("li",[_._v("将 "),v("code",[_._v("t_msg")]),_._v(" 中的 "),v("code",[_._v("status")]),_._v(" 置为 1（投递成功）")])])]),_._v(" "),v("li",[v("strong",[_._v("失败")]),_._v(":\n"),v("ul",[v("li",[_._v("事务回滚")]),_._v(" "),v("li",[_._v("消息记录未写入数据库")])])])])])]),_._v(" "),v("h2",{attrs:{id:"_2-异常情况处理"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_2-异常情况处理"}},[_._v("#")]),_._v(" 2. 异常情况处理")]),_._v(" "),v("ul",[v("li",[v("strong",[_._v("Step 5 失败")]),_._v(":\n"),v("ul",[v("li",[_._v("业务执行成功，但消息投递失败")]),_._v(" "),v("li",[_._v("需要补偿机制：Job 来重试投递消息")])])])]),_._v(" "),v("h2",{attrs:{id:"_3-消息投递补偿-job"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_3-消息投递补偿-job"}},[_._v("#")]),_._v(" 3. 消息投递补偿 Job")]),_._v(" "),v("ul",[v("li",[v("strong",[_._v("查询")]),_._v(":\n"),v("ul",[v("li",[_._v("从本地 "),v("code",[_._v("t_msg")]),_._v(" 表中查询状态为 0 或需要重试的记录")])])]),_._v(" "),v("li",[v("strong",[_._v("重试逻辑")]),_._v(":\n"),v("ul",[v("li",[_._v("第 1 次失败：10 秒后重试")]),_._v(" "),v("li",[_._v("第 2 次失败：20 秒后重试")]),_._v(" "),v("li",[v("strong",[_._v("衰减重试")]),_._v("：每次重试间隔时间增加")]),_._v(" "),v("li",[_._v("设置最大重试次数")])])]),_._v(" "),v("li",[v("strong",[_._v("最终失败处理")]),_._v(":\n"),v("ul",[v("li",[_._v("达到最大重试次数仍失败")]),_._v(" "),v("li",[_._v("触发告警")]),_._v(" "),v("li",[_._v("需要人工干预")])])])]),_._v(" "),v("h2",{attrs:{id:"总结"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[_._v("#")]),_._v(" 总结")]),_._v(" "),v("ul",[v("li",[v("strong",[_._v("事务消息投递过程")]),_._v("：\n"),v("ul",[v("li",[_._v("本地事务 -> 执行业务 -> 记录消息 -> 提交事务 -> 投递消息")])])]),_._v(" "),v("li",[v("strong",[_._v("异常情况处理")]),_._v("：\n"),v("ul",[v("li",[_._v("业务执行成功但消息投递失败，需要补偿机制")])])]),_._v(" "),v("li",[v("strong",[_._v("消息投递补偿 Job")]),_._v("：\n"),v("ul",[v("li",[_._v("查询失败记录 -> 衰减重试 -> 最大重试次数 -> 告警和人工干预")])])])]),_._v(" "),v("h2",{attrs:{id:"send方法流程"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#send方法流程"}},[_._v("#")]),_._v(" send方法流程")]),_._v(" "),v("p",[v("img",{attrs:{src:"https://apple-web.oss-cn-hangzhou.aliyuncs.com/img/202406301538697.png",alt:"image-20240630142701983"}})]),_._v(" "),v("ul",[v("li",[_._v("将消息转换为json格式")]),_._v(" "),v("li",[_._v("判断是否存在事务\n"),v("ul",[v("li",[_._v("如果存在事务\n"),v("ul",[v("li",[_._v("先将消息批量入库，返回MsgPO列表")]),_._v(" "),v("li",[_._v("注册事务同步器，用于在事务完成后执行异步任务")])])]),_._v(" "),v("li",[_._v("如果不存在事务\n"),v("ul",[v("li",[_._v("直接将消息投递到MQ")])])])])]),_._v(" "),v("li",[_._v("异步任务中调用transactionAfter方法，处理消息投递（即使失败了，会有补偿JOB进行重试）\n"),v("strong",[_._v("代码走到这里时，事务已经完成了（可能是回滚了、或者是提交了），看下本地消息记录是否存在？")]),_._v(" "),v("ul",[v("li",[_._v("存在：说明事务是成功的，业务是执行成功的，则投递消息 & 并将消息状态置为成功")]),_._v(" "),v("li",[_._v("不存在：说明事务执行失败了，消息未投递，由于插入消息和业务在一个事务中，事务执行失败，此时db中也是没有消息记录")])])])]),_._v(" "),v("h1",{attrs:{id:"延迟消息"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#延迟消息"}},[_._v("#")]),_._v(" 延迟消息")]),_._v(" "),v("p",[v("img",{attrs:{src:"https://apple-web.oss-cn-hangzhou.aliyuncs.com/img/202406301538678.png",alt:"image-20240630144525141"}})])])}),[],!1,null,null,null);v.default=l.exports}}]);