(window.webpackJsonp=window.webpackJsonp||[]).push([[65],{372:function(a,s,t){"use strict";t.r(s);var r=t(8),n=Object(r.a)({},(function(){var a=this,s=a._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("p",[s("strong",[a._v("高并发、微服务 、性能调优实战案例100讲，所有案例均源于个人工作实战，均配合代码落地")])]),a._v(" "),s("p",[a._v("加我微信：itsoku，所有案例均提供在线答疑。")]),a._v(" "),s("h1",{attrs:{id:"分片上传"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#分片上传"}},[a._v("#")]),a._v(" 分片上传")]),a._v(" "),s("h2",{attrs:{id:"什么是普通上传"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#什么是普通上传"}},[a._v("#")]),a._v(" 什么是普通上传")]),a._v(" "),s("p",[a._v("调用接口一次性完成一个文件的上传。")]),a._v(" "),s("h2",{attrs:{id:"普通上传2个缺点"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#普通上传2个缺点"}},[a._v("#")]),a._v(" 普通上传2个缺点")]),a._v(" "),s("ol",[s("li",[a._v("文件无法续传，比如上传了一个比较大的文件，中间突然断掉了，需要重来")]),a._v(" "),s("li",[a._v("大文件上传太慢")])]),a._v(" "),s("h2",{attrs:{id:"解决方案"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#解决方案"}},[a._v("#")]),a._v(" 解决方案")]),a._v(" "),s("p",[a._v("分片上传")]),a._v(" "),s("h2",{attrs:{id:"什么是分片上传"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#什么是分片上传"}},[a._v("#")]),a._v(" 什么是分片上传")]),a._v(" "),s("p",[a._v("将源文件切分成很多分片，进行上传，待所有分片上传完毕之后，将所有分片合并，便可得到源文件。")]),a._v(" "),s("p",[a._v("这里面的分片可以采用并行的方式上传，提示大文件上传的效率。")]),a._v(" "),s("h2",{attrs:{id:"分片上传主要的过程-3步"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#分片上传主要的过程-3步"}},[a._v("#")]),a._v(" 分片上传主要的过程（3步）")]),a._v(" "),s("ol",[s("li",[s("p",[a._v("创建分片上传任务（分片数量、每个分片文件大小、文件md5值）")])]),a._v(" "),s("li",[s("p",[a._v("上传所有分片")])]),a._v(" "),s("li",[s("p",[a._v("待所有分片上传完成后，合并文件，便可得到源文件")])])]),a._v(" "),s("h2",{attrs:{id:"需要用到2张表"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#需要用到2张表"}},[a._v("#")]),a._v(" 需要用到2张表")]),a._v(" "),s("h3",{attrs:{id:"_1-分片上传任务表-t-shard-upload"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-分片上传任务表-t-shard-upload"}},[a._v("#")]),a._v(" 1. 分片上传任务表(t_shard_upload)")]),a._v(" "),s("p",[a._v("每个分片任务会在此表创建一条记录")]),a._v(" "),s("div",{staticClass:"language-sql line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("create")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("table")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("if")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("not")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("exists")]),a._v(" t_shard_upload"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("\n    id "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("varchar")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("32")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("primary")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("key")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n    file_name "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("varchar")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("256")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("not")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[a._v("null")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("comment")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'文件名称'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n    part_num "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("int")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("not")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[a._v("null")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("comment")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'分片数量'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n    md5 "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("varchar")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("128")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("comment")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'文件md5值'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n    file_full_path "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("varchar")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("512")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("comment")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'文件完整路径'")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("comment")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'分片上传任务表'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br")])]),s("h3",{attrs:{id:"_2-分片文件表-t-shard-upload-part"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-分片文件表-t-shard-upload-part"}},[a._v("#")]),a._v(" 2. 分片文件表（t_shard_upload_part）")]),a._v(" "),s("p",[a._v("这个表和上面的表是1对多的关系，用与记录每个分片的信息，比如一个文件被切分成10个分片，那么此表会产生10条记录")]),a._v(" "),s("div",{staticClass:"language-sql line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("create")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("table")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("if")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("not")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("exists")]),a._v("  t_shard_upload_part"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("\n    id "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("varchar")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("32")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("primary")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("key")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n    shard_upload_id "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("varchar")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("32")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("not")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[a._v("null")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("comment")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'分片任务id（t_shard_upload.id）'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n    part_order "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("int")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("not")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[a._v("null")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("comment")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'第几个分片，从1开始'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n    file_full_path "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("varchar")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("512")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("comment")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'文件完整路径'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("UNIQUE")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("KEY")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token identifier"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("`")]),a._v("uq_part_order"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("`")])]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token identifier"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("`")]),a._v("shard_upload_id"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("`")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),s("span",{pre:!0,attrs:{class:"token identifier"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("`")]),a._v("part_order"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("`")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("comment")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v("'分片文件表，每个分片文件对应一条记录'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br")])]),s("h2",{attrs:{id:"服务端需提供4个接口"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#服务端需提供4个接口"}},[a._v("#")]),a._v(" 服务端需提供4个接口")]),a._v(" "),s("h3",{attrs:{id:"_1-创建分片上传任务-shardupload-init"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-创建分片上传任务-shardupload-init"}},[a._v("#")]),a._v(" 1. 创建分片上传任务(/shardUpload/init)")]),a._v(" "),s("blockquote",[s("p",[a._v("返回分片任务id（shardUploadId），后续的3个接口均需要用到该id")])]),a._v(" "),s("h3",{attrs:{id:"_2-上传分片文件-shardupload-uploadpart"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-上传分片文件-shardupload-uploadpart"}},[a._v("#")]),a._v(" 2. 上传分片文件(/shardUpload/uploadPart)")]),a._v(" "),s("h3",{attrs:{id:"_3-合并分片、完成上传-shardupload-complete"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-合并分片、完成上传-shardupload-complete"}},[a._v("#")]),a._v(" 3. 合并分片、完成上传(/shardUpload/complete)")]),a._v(" "),s("h3",{attrs:{id:"_4-获取分片任务详细信息-shardupload-detail"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-获取分片任务详细信息-shardupload-detail"}},[a._v("#")]),a._v(" 4. 获取分片任务详细信息(/shardUpload/detail)")]),a._v(" "),s("blockquote",[s("p",[a._v("可以得到分片任务的状态信息，如分片任务是否上传完毕，哪些分片已上传等信息，网络出现故障，可以借助此接口恢复上传")])]),a._v(" "),s("h2",{attrs:{id:"上传途中出现故障如何恢复"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#上传途中出现故障如何恢复"}},[a._v("#")]),a._v(" 上传途中出现故障如何恢复？")]),a._v(" "),s("p",[a._v("比如出现网络故障，导致分片上失败，此时需要走恢复逻辑，分两种情况")]),a._v(" "),s("h3",{attrs:{id:"情况1-浏览器无法读取刚才用户选择的文件了"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#情况1-浏览器无法读取刚才用户选择的文件了"}},[a._v("#")]),a._v(" 情况1：浏览器无法读取刚才用户选择的文件了")]),a._v(" "),s("p",[a._v("此时需要用户重新选择文件，重新上传。")]),a._v(" "),s("p",[a._v("这个地方也可以给大家提供另外一种思路，第1个接口创建分片任务的时候传入了文件的md5，按说这个值是具有唯一性的，那么就可以通过这个值找到刚才的任务，按照这种思路，就需要后端提供一个新的接口：通过文件的md5值找到刚才失败的那个任务，然后继续上传未上传的分片。")]),a._v(" "),s("h3",{attrs:{id:"情况2-浏览器可以继续读取刚才用户选择的文件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#情况2-浏览器可以继续读取刚才用户选择的文件"}},[a._v("#")]),a._v(" 情况2：浏览器可以继续读取刚才用户选择的文件")]),a._v(" "),s("p",[a._v("这种情况，可以先调用第4个接口，通过此接口可以知道那些分片还未上传，然后继续上传这些分片就可以了。")]),a._v(" "),s("h2",{attrs:{id:"源码解析"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#源码解析"}},[a._v("#")]),a._v(" 源码解析")]),a._v(" "),s("h3",{attrs:{id:"接口代码"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#接口代码"}},[a._v("#")]),a._v(" 接口代码")]),a._v(" "),s("div",{staticClass:"language-java line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token class-name"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[a._v("com"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("itsoku"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("lesson001"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("controller"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")])]),a._v("ShardUploadController")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("h3",{attrs:{id:"测试用例代码"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#测试用例代码"}},[a._v("#")]),a._v(" 测试用例代码")]),a._v(" "),s("div",{staticClass:"language-java line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token class-name"}},[s("span",{pre:!0,attrs:{class:"token namespace"}},[a._v("com"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("itsoku"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("lesson001"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")])]),a._v("ShardUploadTest")]),a._v("#shardUpload\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("h2",{attrs:{id:"源码如何获取-加我微信-itsoku"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#源码如何获取-加我微信-itsoku"}},[a._v("#")]),a._v(" 源码如何获取？加我微信：itsoku")]),a._v(" "),s("p",[a._v("视频号：程序员路人甲")]),a._v(" "),s("p",[a._v("公众号：路人甲Java")]),a._v(" "),s("p",[a._v("个人网站：http://itsoku.com/")]),a._v(" "),s("h2",{attrs:{id:"所有案例均提供在线技术支持-答疑"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#所有案例均提供在线技术支持-答疑"}},[a._v("#")]),a._v(" 所有案例均提供在线技术支持&答疑")])])}),[],!1,null,null,null);s.default=n.exports}}]);